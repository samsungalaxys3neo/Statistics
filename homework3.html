<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Homework 3 | RSA & Frequency Attack</title>
  <link href="https://fonts.cdnfonts.com/css/cascadia-code" rel="stylesheet">
  <style>
    /* Stesso stile dell'Homework 2 - EXACT MATCH */
    :root {
      --bg: #0a0010;
      --accent: #b6ffb6;
      --accent-dim: rgba(182,255,182,.25);
      --glow: #b6ffb6;
      --text: #f4fff7;
      --subtitle: #8aff8a;
      --chart-bar: #b6ffb6;
      --heatmap-base: #0a2a0a;
      --heatmap-high: #b6ffb6;
    }
    body.cyberpunk-mode {
      --bg: #000;
      --accent: #ff00cc;
      --accent-dim: rgba(255,0,204,.25);
      --glow: #ff00cc;
      --text: #eaffef;
      --subtitle: #ff88ff;
      --chart-bar: #ff00cc;
      --heatmap-base: #2a002a;
      --heatmap-high: #ff00ff;
    }

    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{
      background:var(--bg);
      color:var(--text);
      font-family:'Cascadia Code', monospace;
      overflow-x:hidden;
      padding:2rem;
      transition:background .6s ease, color .6s ease;
    }
    
    b.highlight {
      color: var(--accent);
      text-shadow: 0 0 6px var(--glow);
      font-weight: bold;
    }

    #toggle{
      position:fixed;top:16px;right:16px;z-index:10;
      background:linear-gradient(145deg,var(--accent),var(--glow));
      color:#000;border:none;
      padding:.55rem 1rem;border-radius:10px;cursor:pointer;
      font-weight:bold;box-shadow:0 0 12px var(--glow),inset 0 0 5px rgba(255,255,255,.2);
      transition:transform .25s, box-shadow .25s;
    }
    #toggle:hover{transform:scale(1.05);box-shadow:0 0 18px var(--glow);}

    .container{
      max-width:900px;margin:6rem auto;padding:2rem 2.5rem;
      background:rgba(0,0,0,0.85);
      border:1px solid var(--accent-dim);
      border-radius:12px;
      box-shadow:0 0 20px var(--accent-dim), inset 0 0 10px rgba(255,255,255,0.05);
    }
    h1,h2,h3,h4{color:var(--accent);text-shadow:0 0 8px var(--glow);text-align:center;}
    h1{font-size:2.3rem;margin-bottom:.4rem;}
    h2{font-size:1.2rem;margin-bottom:1.8rem;opacity:.9;}
    h3{margin-top:2.5rem;margin-bottom:.8rem;color:var(--subtitle);text-align:left; border-bottom: 1px solid var(--accent-dim); padding-bottom: 0.5rem;}
    h4{margin-top:1rem;margin-bottom:.5rem;font-size:1rem;color:var(--subtitle);text-align:left;}
    p{margin-bottom:1rem;text-align:left;line-height:1.6;}

    .btn{
      display:block;margin:1rem auto;background:transparent;border:1px solid var(--accent-dim);
      color:var(--accent);padding:.5rem .9rem;border-radius:8px;cursor:pointer;text-shadow:0 0 8px var(--glow);transition:.25s;
    }
    .btn:hover{background:var(--accent);color:#000;}

    /* Charts Area */
    .chart-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        justify-content: center;
        margin: 2rem 0;
    }
    canvas {
        background:rgba(0,0,0,0.8);
        border-radius:10px;
        box-shadow:0 0 20px var(--accent-dim);
    }
    .main-chart { width: 100%; max-width: 850px; height: 250px; }
    .heatmap-chart { width: 300px; height: 300px; }

    textarea{width:100%;margin:1rem 0;padding:1rem;border-radius:8px;border:1px solid var(--accent-dim);font-family:'Cascadia Code',monospace;background:#171717;color:var(--accent);height:150px;resize:vertical;overflow-y:auto;}
    
    .terminal-log {
        background: #0f0f0f;
        color: #00ff00;
        font-family: 'Courier New', Courier, monospace;
        font-size: 0.9rem;
        padding: 1rem;
        height: 300px;
        overflow-y: scroll;
        border: 1px solid #333;
        white-space: pre-wrap;
        box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
    }

    .input-group {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      align-items: center;
    }
    .input-group label {
      font-weight: bold;
      color: var(--subtitle);
      flex-basis: 120px;
    }
    .input-group input {
      flex-grow: 1;
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid var(--accent-dim);
      background: #171717;
      color: var(--text);
      font-family: 'Cascadia Code', monospace;
    }
    .key-display {
      background: #171717;
      padding: 0.75rem;
      border-radius: 8px;
      border: 1px solid var(--accent-dim);
      color: var(--accent);
      word-wrap: break-word;
      margin-bottom: 0.5rem;
    }

    hr{margin:2.5rem 0;border:none;border-top:2px solid var(--accent-dim);}

    @media (max-width: 768px) {
      body { padding: 1rem; }
      .container { margin: 4rem auto; padding: 1.5rem; width: 95%; }
      h1 { font-size: 1.8rem; }
      .input-group { flex-direction: column; align-items: stretch; }
      .input-group label { flex-basis: auto; margin-bottom: 0.25rem; }
      .main-chart, .heatmap-chart { width: 100%; height: auto; }
      #toggle { top: 10px; right: 10px; }
    }
  </style>
</head>
<body>
<button id="toggle">Matrix Mode</button>

<div class="container">
  <h1>Homework_3</h1>
  <h2>RSA Encryption & Hill Climbing Attack</h2>

  <!-- THEORY SECTION -->
  <h3>&gt; Theory: RSA & The Flaw</h3>
  <p>RSA is typically secure because factoring <b class="highlight">n = p * q</b> is hard. However, "Textbook RSA" (encrypting character-by-character) creates a deterministic pattern.</p>
  <ul>
    <li><b class="highlight">The Flaw:</b> Encrypting 'A' always yields the same number. Encrypting 'B' yields another constant number. This turns RSA into a simple <b class="highlight">Substitution Cipher</b>, vulnerable to frequency analysis.</li>
  </ul>

  <hr>

  <!-- STEP 1: TRAINING -->
  <h3>&gt; Step 1 – Language Training (Monograms & Bigrams)</h3>
  <p>To crack the code, the algorithm first needs to "learn" the language (Italian) by analyzing a reference text. It builds a matrix of <b>Bigrams</b> (letter pairs).</p>
  
  <h4>Reference Corpus:</h4>
  <textarea id="trainingText" placeholder="Paste a book or long text here...">
    Nell'ombra della casa, sulle rive soleggiate del fiume presso le
barche, nell'ombra del bosco di Sal, all'ombra del fico crebbe
Siddharta, il bel figlio del Brahmino, il giovane falco, insieme
all'amico suo, Govinda, anch'egli figlio di Brahmino. Sulla riva
del fiume, nei bagni, nelle sacre abluzioni, nei sacrifici votivi il
sole bruniva le sue spalle lucenti. Ombre attraversavano i suoi
occhi neri nel boschetto di mango, durante i giochi infantili, al
canto di sua madre, durante i santi sacrifici, alle lezioni di suo
padre, così dotto, durante le conversazioni dei saggi. Già da tempo
Siddharta prendeva parte alle conversazioni dei saggi, si
esercitava con Govinda nell'arte oratoria, nonché nell'esercizio
delle facoltà di osservazione e nella pratica della concentrazione
interiore. Già egli sapeva come si pronuncia impercettibilmente
1'Om, la parola suprema, sapeva assorbirla in se stesso
pronunciandola silenziosamente nell'atto di inspirare, sapeva
emetterla silenziosamente nell'atto di espirare, con l'anima
raccolta, la fronte raggiante dello splendore che emana da uno
spirito luminoso. Già egli sapeva, nelle profondità del proprio
essere, riconoscere l'Atman, indistruttibile, uno con la totalità del
mondo.
Il cuore del padre balzava di gioia per quel figlio così studioso,
così avido di sapere; era un grande sapiente, un sommo sacerdote
quello ch'egli vedeva svilupparsi in lui: un principe fra i Brahmini.
La gioia gonfiava il petto di sua madre quand'ella lo guardava,
quando lo vedeva camminare, quando lo vedeva sedere e alzarsi:
Siddharta, così forte, così bello, che procedeva col suo passo
snello, che la salutava con garbo così compìto.
17
Siddharta – Parte Prima
L'amore si agitava nel cuore delle giovani figlie dei Brahmini,
quando Siddharta passava per le strade della città, con la sua
fronte luminosa, con i suoi occhi regali, così slanciato e nobile
nella persona.
Ma più di tutti lo amava l'amico suo Govinda, il figlio del
Brahmino. Amava gli occhi di Siddharta e la sua cara voce, amava
il suo passo e il garbo perfetto dei movimenti, amava tutto ciò che
Siddharta diceva e faceva, ma soprattutto ne amava lo spirito, i
suoi alti, generosi pensieri, la sua volontà ardente, la vocazione
sublime. Sapeva bene Govinda: questo non diventerà un
Brahmino come ce n'è tanti, un pigro ministro di sacrifici, o un
avido mercante d'incantesimi, un vano e vacuo retore, un prete
astuto e cattivo, e non sarà nemmeno una buona, sciocca pecora
nel gregge dei molti. No, e anch'egli, Govinda, non voleva
diventare tale, un Brahmino come ce ne son migliaia. Voleva
seguire Siddharta, il prediletto, il magnifico. E se un giorno
Siddharta fosse diventato un dio, se fosse asceso un giorno nella
gloria dei celesti, allora Govinda l'avrebbe seguito, come suo
amico, suo compagno, suo servo, suo scudiere, sua ombra.
Così tutti amavano Siddharta. A tutti egli dava gioia, tutti ne
traevano piacere. Ma egli, Siddharta, a sé stesso non procurava
piacere, non era di gioia a sé stesso. Passeggiando sui sentieri
rosati del frutteto, sedendo nell'ombra azzurrina del boschetto
delle contemplazioni, purificando le proprie membra nel
quotidiano lavacro di espiazione, celebrando i sacrifici nel bosco
di mango dalle ombre profonde, con la sua perfetta compitezza
d'atteggiamenti, amato da tutti, di gioia a tutti, pure non portava
gioia in cuore. Lo assalivano sogni e pensieri irrequieti, portati
fino a lui dalla corrente del fiume, scintillati dalle stelle della
notte, dardeggiati dai raggi del sole; sogni lo assalivano, e
un'agitazione dell'anima, vaporata dai sacrifici, esalante dai versi
del Rig Veda, stillata dalle dottrine dei vecchi testi brahminici.
Siddharta aveva cominciato ad alimentare in sé la scontentezza.
Aveva cominciato a sentire che l'amore di suo padre e di sua
18
Il Figlio del Brahmino
madre, e anche l'amore dell'amico suo, Govinda, non avrebbero
fatto per sempre la sua eterna felicità, non gli avrebbero dato la
quiete, non l'avrebbero saziato, non gli sarebbero bastati. Aveva
cominciato a sospettare che il suo degnissimo padre e gli altri suoi
maestri, cioè i saggi Brahmini, gli avevano già impartito il più e il
meglio della loro saggezza, avevano già versato interamente i loro
vasi pieni nel suo recipiente in attesa, ma questo recipiente non
s'era riempito, lo spirito non era soddisfatto, l'anima non era
tranquilla, non placato il cuore.
Buona cosa le abluzioni, certo: ma erano acqua, non lavavano
via il peccato, non guarivano la sete dello spirito, non
scioglievano gli affanni del cuore. Eccellente cosa i sacrifici e la
preghiera agli dèi: ma questo era tutto? Davano i sacrifici la
felicità? E come stava questa faccenda degli dèi? Era realmente
Prajapati che aveva creato il mondo? Non era invece 1'Atman,
l'unico, il solo, il Tutto? Che gli dèi non fossero poi forme create,
come tu e io, soggette al tempo, caduche? Anzi, era poi bene, era
giusto, era un atto sensato e sublime sacrificare agli dèi? A chi
altri si doveva sacrificare, a chi altri si doveva rendere onore, se
non a Lui, all'Unico, all'Atman?
E dove si poteva trovare 1'Atman, dove abitava, dove batteva il
suo eterno cuore, dove altro mai se non nel più profondo del
proprio io, in quel che di indistruttibile ognuno porta in sé? Ma
dove, dov'era questo Io, questa interiorità, questo assoluto? Non
era carne e ossa, non era pensiero né coscienza: così insegnavano i
più saggi. Dove, dove dunque era? Penetrare laggiù, fino all'Io, a
me, all'Atman: c'era forse un'altra via che mettesse conto di
esplorare? Ahimè! questa via nessuno la insegnava, nessuno la
conosceva, non il padre, non i maestri e i saggi, non i pii canti dei
sacrifici! Tutto sapevano i Brahmini e i loro libri sacri, tutto, e
perfino qualche cosa di più; di tutto s'erano occupati, della
creazione del mondo, della natura del linguaggio, dei cibi,
dell'inspirare e dell'espirare, della gerarchia dei cinque sensi, dei
fatti degli dèi... cose infinite sapevano... Ma valeva la pena saper
19
Siddharta – Parte Prima
tutto questo, se non si sapeva l'Uno e il Tutto, la cosa più
importante di tutte, la sola cosa importante?
Certo, molti versi dei libri santi, specialmente nelle Upanishad
di Samaveda, parlavano di questa interiorità e di quest'assoluto;
splendidi versi: «L'anima tua è l'intero mondo», così vi stava
scritto. E vi stava scritto che l'uomo nel sonno, nel profondo
sonno, penetra nel proprio Io e prende stanza nell'Atman.
Meravigliosa saggezza stava in questi versi, tutta la scienza dei
più saggi stava qui radunata in magiche parole, pura come miele.
No, non si doveva certo far poco conto della prodigiosa
conoscenza che qui era stata raccolta e conservata da
innumerevoli generazioni di Brahmini.
Ma dov'erano i saggi, dove i sacerdoti o i penitenti, ai quali
fosse riuscito, non soltanto di conoscerla, questa profondissima
scienza, ma di viverla? Dove era l'esperto che sapesse
magicamente richiamare dal sonno allo stato di veglia l'esperienza
dell'Atman, ricondurla nella vita quotidiana, nella parola e
nell'azione? Molti degni Brahmini conosceva Siddharta, suo padre
prima di tutti, il puro, il dotto, degno sopra ogni altro. Ammirabile
era suo padre, nobile e calmo il suo contegno, pura la sua vita,
saggia la sua parola, squisiti e alti pensieri avevan dimora dietro la
sua fronte... ma anche lui, che tanto sapeva, viveva forse nella
beatitudine, possedeva la pace, non era anche lui soltanto un uomo
che cerca, un assetato? Non doveva egli sempre riattingere, come
un assetato, alle sacre fonti, sacrifici, libri, conversazioni dei
Brahmini? Perché doveva anche lui, l'irreprensibile, purificarsi
ogni giorno dal peccato, affannarsi per le abluzioni, sempre da
capo, ogni giorno?
Dunque non era in lui 1'Atman, non zampillava nel suo cuore
la fonte originaria? Eppure era questa che bisognava trovare:
scoprire la fonte originaria nel proprio Io, e impadronirsene! Tutto
il resto era ricerca, era errore e deviazione.
Tali erano i pensieri di Siddharta, questa era la sua sete, questo
il suo tormento.
20
Il Figlio del Brahmino
Spesso egli recitava a sé stesso le parole di una ChandogyaUpanishad: «In verità, Satyam è il nome di Brahma: in verità, chi
sa questo, ascende ogni giorno nel mondo celeste». Spesso gli
pareva vicino, il mondo celeste, ma mai l'aveva raggiunto
interamente, mai aveva spento l'ultima sete. E di tutti i saggi e
dottissimi ch'egli conosceva, valendosi del loro insegnamento,
non uno ve n'era che l'avesse raggiunto interamente, il mondo
celeste, non uno che interamente l'avesse spenta, l'eterna sete.
«Govinda», disse Siddharta all'amico «Govinda, caro, vieni
con me sotto il banano: vogliamo esercitarci nella
concentrazione».
Andarono verso il banano, sedettero a terra, qui Siddharta,
venti passi più in là Govinda. Mentre sedeva, pronto a pronunciare
l'Om, Siddharta ripeteva mormorando i versi: “Om è l'arco, la
saetta è l'anima, bersaglio della saetta è Brahma, da colpire con
immobile certezza”.
Quando il tempo consueto della concentrazione fu trascorso,
Govinda si alzò. Era calata la sera, era tempo di cominciare
l'abluzione vespertina. Govinda chiamò Siddharta per nome, ma
non ottenne risposta. Siddharta sedeva assorto, i suoi occhi erano
fissati rigidamente sopra una meta lontana, la punta della lingua
spuntava un poco fra i denti: pareva ch'egli non respirasse. Così
sedeva, immerso nella concentrazione, pensando 1'Om, l'anima
indirizzata a Brahma come una saetta.
E un giorno passarono i Samana attraverso la città di Siddharta:
asceti girovaghi, tre uomini secchi e spenti, né vecchi né giovani,
con spalle impolverate e sanguinose, arsi dal sole, circondati di
solitudine, estranei e ostili al mondo, forestieri nel regno degli
uomini come macilenti sciacalli. Spirava da loro un'aura di cheta
passione, di devozione fino all'annientamento, di spietata rinuncia
alla personalità.
A sera, dopo l'ora dell'osservazione, Siddharta comunicò a
Govinda: «Domani mattina per tempo, amico mio, Siddharta
andrà dai Samana. Diventerà un Samana anche lui».
21
Siddharta – Parte Prima
A queste parole Govinda impallidì, e nel volto immobile
dell'amico lesse la decisione, inarrestabile come la saetta, scagliata
dall'arco. Subito, al primo sguardo, Govinda si rese conto: ora
comincia, ora trova Siddharta la sua via, ora comincia il suo
destino a germogliare, e con il suo il mio. E divenne pallido, come
una buccia di banana secca. «O Siddharta», esclamò «te lo
permetterà tuo padre?».
Siddharta sollevò lo sguardo, come uno che si ridesta.
Fulmineamente lesse nell'anima di Govinda: vi lesse la paura, vi
lesse la dedizione. «O Govinda», rispose sommessamente «è
inutile sprecar parole. Domani all'alba comincerò la vita del
Samana. Non parliamone più».
Siddharta entrò nella camera dove suo padre sedeva sopra una
stuoia di corteccia, s'avanzò alle sue spalle e rimase là, fermo,
finché suo padre s'accorse che c'era qualcuno dietro di lui. Disse il
Brahmino: «Sei tu, Siddharta? Allora dì quel che sei venuto per
dire».
Parlò Siddharta: «Col tuo permesso, padre mio. Sono venuto
ad annunciarti che desidero abbandonare la casa domani mattina
e recarmi fra gli asceti. Diventare un Samana, questo è il mio
desiderio. Voglia il cielo che mio padre non si opponga».
Tacque il Brahmino: tacque così a lungo che nella piccola
finestra le stelle si spostarono e il loro aspetto mutò, prima che
venisse rotto il silenzio nella camera. Muto e immobile stava ritto
il figlio con le braccia conserte, muto e immobile sedeva il padre
sulla stuoia, e le stelle passavano in cielo. Finalmente parlò il
padre: «Non s'addice a un Brahmino pronunciare parole violente
e colleriche. Ma l'irritazione agita il mio cuore. Ch'io non senta
questa preghiera una seconda volta dalla tua bocca».
Il Brahmino si alzò lentamente; Siddharta restava in piedi,
muto, con le braccia conserte. «Che aspetti?» chiese il padre.
Disse Siddharta: «Tu lo sai».
Irritato uscì il padre dalla stanza, irritato cercò il suo giaciglio e
si coricò.
22
Il Figlio del Brahmino
Dopo un'ora, poiché il sonno tardava, il Brahmino si alzò,
passeggiò in su e in giù, uscì di casa. Guardò attraverso la piccola
finestra della stanza, e vide Siddharta in piedi, con le braccia
conserte: non s'era mosso. Come un pallido bagliore emanava dal
suo mantello bianco. Col cuore pieno d'inquietudine, il padre
ritornò al suo giaciglio.
E venne di nuovo dopo un'ora, venne dopo due ore, guardò
attraverso la piccola finestra, vide Siddharta in piedi, nel chiaro di
luna, al bagliore delle stelle, nelle tenebre. E ritornò ogni ora, in
silenzio, guardò nella camera, vide quel ragazzo in piedi,
immobile, ed il suo cuore si riempì di collera, il suo cuore si
riempì di disagio, il suo cuore si riempì d'incertezza, il suo cuore
si riempì di compassione.
Ritornò nell'ultima ora della notte, prima che il giorno
spuntasse, entrò nella stanza, vide il giovane in piedi, e gli parve
grande, quasi straniero. «Siddharta», chiese «che attendi?».
«Tu lo sai».
«Starai sempre così ad aspettare che venga giorno,
mezzogiorno e sera?».
«Starò ad aspettare».
«Ti stancherai, Siddharta».
«Mi stancherò».
«Ti addormenterai, Siddharta».
«Non mi addormenterò».
«Morirai, Siddharta».
«Morirò».
«E preferisci morire, piuttosto che obbedire a tuo padre?».
«Siddharta ha sempre obbedito a suo padre».
«Allora rinunci al tuo proposito?».
«Siddharta farà ciò che suo padre gli dirà di fare».
Le prime luci del giorno entravano nella stanza. Il Brahmino
vide che Siddharta tremava leggermente sulle ginocchia. Nel volto
di Siddharta, invece, non si vedeva alcun tremito: gli occhi
guardavano lontano. Allora il padre s'accorse che Siddharta non
23
Siddharta – Parte Prima
abitava già più con lui in quella casa: Siddharta l'aveva già
abbandonato.
Il padre posò la mano sulla spalla di Siddharta. «Andrai nella
foresta», disse «e diverrai un Samana. Se nella foresta troverai la
beatitudine, ritorna, e insegnami la beatitudine. Se troverai la
delusione, ritorna: riprenderemo insieme a sacrificare agli dèi.
Ora va' a baciar tua madre, dille dove vai. Ma per me è tempo
d'andare al fiume e di compiere la prima abluzione».
Tolse la mano dalla spalla di suo figlio, e uscì. Siddharta
barcollò, quando provò a muoversi. Ma fece forza alle sue
membra, s'inchinò davanti al padre e andò dalla mamma, per fare
come suo padre aveva prescritto.
Quando alle prime luci del giorno, lentamente, con le gambe
indolenzite, lasciò la città ancora silenziosa, un'ombra, ch'era
accucciata presso l'ultima capanna, si levò e s'unì al pellegrino:
Govinda. «Sei venuto» disse Siddharta, e sorrise.
«Sono venuto» disse Govinda.
    </textarea>
  <button class="btn" id="trainBtn">&gt; Train Language Model</button>
  <p id="trainStatus" style="color:var(--subtitle); font-size: 0.9rem;">&gt; Status: Model empty.</p>
  
  <div class="chart-container">
      <div>
          <h4 style="text-align:center; margin-bottom:5px;">Frequency Distribution</h4>
          <canvas id="langChart" width="500" height="300" class="heatmap-chart" style="width:500px;"></canvas>
      </div>
      <div>
          <h4 style="text-align:center; margin-bottom:5px;">Bigram Heatmap (Letter Pairs)</h4>
          <canvas id="bigramChart" width="300" height="300" class="heatmap-chart"></canvas>
      </div>
  </div>

  <hr>

  <!-- STEP 2: RSA SETUP -->
  <h3>&gt; Step 2 – RSA Key Configuration</h3>
  <div class="input-group">
    <label for="p">Prime p:</label>
    <input id="p" type="number" value="61">
    <label for="q">Prime q:</label>
    <input id="q" type="number" value="53">
  </div>
  <div class="input-group">
    <label for="e">Exponent e:</label>
    <input id="e" type="number" value="17">
    <button class="btn" id="setupBtn" style="margin: 0;">&gt; Generate Keys</button>
  </div>
  
  <div style="margin-top: 1rem;">
    <p id="rsa-pub" class="key-display">&gt; Public Key (e, n): ...</p>
    <p id="rsa-priv" class="key-display">&gt; Private Key (d, n): ...</p>
  </div>
  
  <hr>

  <!-- STEP 3: ENCRYPTION -->
  <h3>&gt; Step 3 – Message Encryption</h3>
  <textarea id="inputText" placeholder="Enter secret message to encrypt..."
  >Nell'ombra della casa, sulle rive soleggiate del fiume presso le
barche, nell'ombra del bosco di Sal, all'ombra del fico crebbe
Siddharta, il bel figlio del Brahmino, il giovane falco, insieme
all'amico suo, Govinda, anch'egli figlio di Brahmino. Sulla riva
del fiume, nei bagni, nelle sacre abluzioni, nei sacrifici votivi il
sole bruniva le sue spalle lucenti. Ombre attraversavano i suoi
occhi neri nel boschetto di mango, durante i giochi infantili, al
canto di sua madre, durante i santi sacrifici, alle lezioni di suo
padre, così dotto, durante le conversazioni dei saggi. Già da tempo
Siddharta prendeva parte alle conversazioni dei saggi, si
esercitava con Govinda nell'arte oratoria, nonché nell'esercizio
delle facoltà di osservazione e nella pratica della concentrazione
interiore. Già egli sapeva come si pronuncia impercettibilmente
1'Om, la parola suprema, sapeva assorbirla in se stesso
pronunciandola silenziosamente nell'atto di inspirare, sapeva
emetterla silenziosamente nell'atto di espirare, con l'anima
raccolta, la fronte raggiante dello splendore che emana da uno
spirito luminoso. Già egli sapeva, nelle profondità del proprio
essere, riconoscere l'Atman, indistruttibile, uno con la totalità del
mondo.
Il cuore del padre balzava di gioia per quel figlio così studioso,
così avido di sapere; era un grande sapiente, un sommo sacerdote
quello ch'egli vedeva svilupparsi in lui: un principe fra i Brahmini.
La gioia gonfiava il petto di sua madre quand'ella lo guardava,
quando lo vedeva camminare, quando lo vedeva sedere e alzarsi:
Siddharta, così forte, così bello, che procedeva col suo passo
snello, che la salutava con garbo così compìto.
17
Siddharta – Parte Prima
L'amore si agitava nel cuore delle giovani figlie dei Brahmini,
quando Siddharta passava per le strade della città, con la sua
fronte luminosa, con i suoi occhi regali, così slanciato e nobile
nella persona.
Ma più di tutti lo amava l'amico suo Govinda, il figlio del
Brahmino. Amava gli occhi di Siddharta e la sua cara voce, amava
il suo passo e il garbo perfetto dei movimenti, amava tutto ciò che
Siddharta diceva e faceva, ma soprattutto ne amava lo spirito, i
suoi alti, generosi pensieri, la sua volontà ardente, la vocazione
sublime. Sapeva bene Govinda: questo non diventerà un
Brahmino come ce n'è tanti, un pigro ministro di sacrifici, o un
avido mercante d'incantesimi, un vano e vacuo retore, un prete
astuto e cattivo, e non sarà nemmeno una buona, sciocca pecora
nel gregge dei molti. No, e anch'egli, Govinda, non voleva
diventare tale, un Brahmino come ce ne son migliaia. Voleva
seguire Siddharta, il prediletto, il magnifico. E se un giorno
Siddharta fosse diventato un dio, se fosse asceso un giorno nella
gloria dei celesti, allora Govinda l'avrebbe seguito, come suo
amico, suo compagno, suo servo, suo scudiere, sua ombra.
Così tutti amavano Siddharta. A tutti egli dava gioia, tutti ne
traevano piacere. Ma egli, Siddharta, a sé stesso non procurava
piacere, non era di gioia a sé stesso. Passeggiando sui sentieri
rosati del frutteto, sedendo nell'ombra azzurrina del boschetto
delle contemplazioni, purificando le proprie membra nel
quotidiano lavacro di espiazione, celebrando i sacrifici nel bosco
di mango dalle ombre profonde, con la sua perfetta compitezza
d'atteggiamenti, amato da tutti, di gioia a tutti, pure non portava
gioia in cuore. Lo assalivano sogni e pensieri irrequieti, portati
fino a lui dalla corrente del fiume, scintillati dalle stelle della
notte, dardeggiati dai raggi del sole; sogni lo assalivano, e
un'agitazione dell'anima, vaporata dai sacrifici, esalante dai versi
del Rig Veda, stillata dalle dottrine dei vecchi testi brahminici.
Siddharta aveva cominciato ad alimentare in sé la scontentezza.
Aveva cominciato a sentire che l'amore di suo padre e di sua
18
Il Figlio del Brahmino
madre, e anche l'amore dell'amico suo, Govinda, non avrebbero
fatto per sempre la sua eterna felicità, non gli avrebbero dato la
quiete, non l'avrebbero saziato, non gli sarebbero bastati. Aveva
cominciato a sospettare che il suo degnissimo padre e gli altri suoi
maestri, cioè i saggi Brahmini, gli avevano già impartito il più e il
meglio della loro saggezza, avevano già versato interamente i loro
vasi pieni nel suo recipiente in attesa, ma questo recipiente non
s'era riempito, lo spirito non era soddisfatto, l'anima non era
tranquilla, non placato il cuore.
Buona cosa le abluzioni, certo: ma erano acqua, non lavavano
via il peccato, non guarivano la sete dello spirito, non
scioglievano gli affanni del cuore. Eccellente cosa i sacrifici e la
preghiera agli dèi: ma questo era tutto? Davano i sacrifici la
felicità? E come stava questa faccenda degli dèi? Era realmente
Prajapati che aveva creato il mondo? Non era invece 1'Atman,
l'unico, il solo, il Tutto? Che gli dèi non fossero poi forme create,
come tu e io, soggette al tempo, caduche? Anzi, era poi bene, era
giusto, era un atto sensato e sublime sacrificare agli dèi? A chi
altri si doveva sacrificare, a chi altri si doveva rendere onore, se
non a Lui, all'Unico, all'Atman?
E dove si poteva trovare 1'Atman, dove abitava, dove batteva il
suo eterno cuore, dove altro mai se non nel più profondo del
proprio io, in quel che di indistruttibile ognuno porta in sé? Ma
dove, dov'era questo Io, questa interiorità, questo assoluto? Non
era carne e ossa, non era pensiero né coscienza: così insegnavano i
più saggi. Dove, dove dunque era? Penetrare laggiù, fino all'Io, a
me, all'Atman: c'era forse un'altra via che mettesse conto di
esplorare? Ahimè! questa via nessuno la insegnava, nessuno la
conosceva, non il padre, non i maestri e i saggi, non i pii canti dei
sacrifici! Tutto sapevano i Brahmini e i loro libri sacri, tutto, e
perfino qualche cosa di più; di tutto s'erano occupati, della
creazione del mondo, della natura del linguaggio, dei cibi,
dell'inspirare e dell'espirare, della gerarchia dei cinque sensi, dei
fatti degli dèi... cose infinite sapevano... Ma valeva la pena saper
19
Siddharta – Parte Prima
tutto questo, se non si sapeva l'Uno e il Tutto, la cosa più
importante di tutte, la sola cosa importante?
Certo, molti versi dei libri santi, specialmente nelle Upanishad
di Samaveda, parlavano di questa interiorità e di quest'assoluto;
splendidi versi: «L'anima tua è l'intero mondo», così vi stava
scritto. E vi stava scritto che l'uomo nel sonno, nel profondo
sonno, penetra nel proprio Io e prende stanza nell'Atman.
Meravigliosa saggezza stava in questi versi, tutta la scienza dei
più saggi stava qui radunata in magiche parole, pura come miele.
No, non si doveva certo far poco conto della prodigiosa
conoscenza che qui era stata raccolta e conservata da
innumerevoli generazioni di Brahmini.
Ma dov'erano i saggi, dove i sacerdoti o i penitenti, ai quali
fosse riuscito, non soltanto di conoscerla, questa profondissima
scienza, ma di viverla? Dove era l'esperto che sapesse
magicamente richiamare dal sonno allo stato di veglia l'esperienza
dell'Atman, ricondurla nella vita quotidiana, nella parola e
nell'azione? Molti degni Brahmini conosceva Siddharta, suo padre
prima di tutti, il puro, il dotto, degno sopra ogni altro. Ammirabile
era suo padre, nobile e calmo il suo contegno, pura la sua vita,
saggia la sua parola, squisiti e alti pensieri avevan dimora dietro la
sua fronte... ma anche lui, che tanto sapeva, viveva forse nella
beatitudine, possedeva la pace, non era anche lui soltanto un uomo
che cerca, un assetato? Non doveva egli sempre riattingere, come
un assetato, alle sacre fonti, sacrifici, libri, conversazioni dei
Brahmini? Perché doveva anche lui, l'irreprensibile, purificarsi
ogni giorno dal peccato, affannarsi per le abluzioni, sempre da
capo, ogni giorno?
Dunque non era in lui 1'Atman, non zampillava nel suo cuore
la fonte originaria? Eppure era questa che bisognava trovare:
scoprire la fonte originaria nel proprio Io, e impadronirsene! Tutto
il resto era ricerca, era errore e deviazione.
Tali erano i pensieri di Siddharta, questa era la sua sete, questo
il suo tormento.
20
Il Figlio del Brahmino
Spesso egli recitava a sé stesso le parole di una ChandogyaUpanishad: «In verità, Satyam è il nome di Brahma: in verità, chi
sa questo, ascende ogni giorno nel mondo celeste». Spesso gli
pareva vicino, il mondo celeste, ma mai l'aveva raggiunto
interamente, mai aveva spento l'ultima sete. E di tutti i saggi e
dottissimi ch'egli conosceva, valendosi del loro insegnamento,
non uno ve n'era che l'avesse raggiunto interamente, il mondo
celeste, non uno che interamente l'avesse spenta, l'eterna sete.
«Govinda», disse Siddharta all'amico «Govinda, caro, vieni
con me sotto il banano: vogliamo esercitarci nella
concentrazione».
Andarono verso il banano, sedettero a terra, qui Siddharta,
venti passi più in là Govinda. Mentre sedeva, pronto a pronunciare
l'Om, Siddharta ripeteva mormorando i versi: “Om è l'arco, la
saetta è l'anima, bersaglio della saetta è Brahma, da colpire con
immobile certezza”.
Quando il tempo consueto della concentrazione fu trascorso,
Govinda si alzò. Era calata la sera, era tempo di cominciare
l'abluzione vespertina. Govinda chiamò Siddharta per nome, ma
non ottenne risposta. Siddharta sedeva assorto, i suoi occhi erano
fissati rigidamente sopra una meta lontana, la punta della lingua
spuntava un poco fra i denti: pareva ch'egli non respirasse. Così
sedeva, immerso nella concentrazione, pensando 1'Om, l'anima
indirizzata a Brahma come una saetta.
E un giorno passarono i Samana attraverso la città di Siddharta:
asceti girovaghi, tre uomini secchi e spenti, né vecchi né giovani,
con spalle impolverate e sanguinose, arsi dal sole, circondati di
solitudine, estranei e ostili al mondo, forestieri nel regno degli
uomini come macilenti sciacalli. Spirava da loro un'aura di cheta
passione, di devozione fino all'annientamento, di spietata rinuncia
alla personalità.
A sera, dopo l'ora dell'osservazione, Siddharta comunicò a
Govinda: «Domani mattina per tempo, amico mio, Siddharta
andrà dai Samana. Diventerà un Samana anche lui».
21
Siddharta – Parte Prima
A queste parole Govinda impallidì, e nel volto immobile
dell'amico lesse la decisione, inarrestabile come la saetta, scagliata
dall'arco. Subito, al primo sguardo, Govinda si rese conto: ora
comincia, ora trova Siddharta la sua via, ora comincia il suo
destino a germogliare, e con il suo il mio. E divenne pallido, come
una buccia di banana secca. «O Siddharta», esclamò «te lo
permetterà tuo padre?».
Siddharta sollevò lo sguardo, come uno che si ridesta.
Fulmineamente lesse nell'anima di Govinda: vi lesse la paura, vi
lesse la dedizione. «O Govinda», rispose sommessamente «è
inutile sprecar parole. Domani all'alba comincerò la vita del
Samana. Non parliamone più».
Siddharta entrò nella camera dove suo padre sedeva sopra una
stuoia di corteccia, s'avanzò alle sue spalle e rimase là, fermo,
finché suo padre s'accorse che c'era qualcuno dietro di lui. Disse il
Brahmino: «Sei tu, Siddharta? Allora dì quel che sei venuto per
dire».
Parlò Siddharta: «Col tuo permesso, padre mio. Sono venuto
ad annunciarti che desidero abbandonare la casa domani mattina
e recarmi fra gli asceti. Diventare un Samana, questo è il mio
desiderio. Voglia il cielo che mio padre non si opponga».
Tacque il Brahmino: tacque così a lungo che nella piccola
finestra le stelle si spostarono e il loro aspetto mutò, prima che
venisse rotto il silenzio nella camera. Muto e immobile stava ritto
il figlio con le braccia conserte, muto e immobile sedeva il padre
sulla stuoia, e le stelle passavano in cielo. Finalmente parlò il
padre: «Non s'addice a un Brahmino pronunciare parole violente
e colleriche. Ma l'irritazione agita il mio cuore. Ch'io non senta
questa preghiera una seconda volta dalla tua bocca».
Il Brahmino si alzò lentamente; Siddharta restava in piedi,
muto, con le braccia conserte. «Che aspetti?» chiese il padre.
Disse Siddharta: «Tu lo sai».
Irritato uscì il padre dalla stanza, irritato cercò il suo giaciglio e
si coricò.
22
Il Figlio del Brahmino
Dopo un'ora, poiché il sonno tardava, il Brahmino si alzò,
passeggiò in su e in giù, uscì di casa. Guardò attraverso la piccola
finestra della stanza, e vide Siddharta in piedi, con le braccia
conserte: non s'era mosso. Come un pallido bagliore emanava dal
suo mantello bianco. Col cuore pieno d'inquietudine, il padre
ritornò al suo giaciglio.
E venne di nuovo dopo un'ora, venne dopo due ore, guardò
attraverso la piccola finestra, vide Siddharta in piedi, nel chiaro di
luna, al bagliore delle stelle, nelle tenebre. E ritornò ogni ora, in
silenzio, guardò nella camera, vide quel ragazzo in piedi,
immobile, ed il suo cuore si riempì di collera, il suo cuore si
riempì di disagio, il suo cuore si riempì d'incertezza, il suo cuore
si riempì di compassione.
Ritornò nell'ultima ora della notte, prima che il giorno
spuntasse, entrò nella stanza, vide il giovane in piedi, e gli parve
grande, quasi straniero. «Siddharta», chiese «che attendi?».
«Tu lo sai».
«Starai sempre così ad aspettare che venga giorno,
mezzogiorno e sera?».
«Starò ad aspettare».
«Ti stancherai, Siddharta».
«Mi stancherò».
«Ti addormenterai, Siddharta».
«Non mi addormenterò».
«Morirai, Siddharta».
«Morirò».
«E preferisci morire, piuttosto che obbedire a tuo padre?».
«Siddharta ha sempre obbedito a suo padre».
«Allora rinunci al tuo proposito?».
«Siddharta farà ciò che suo padre gli dirà di fare».
Le prime luci del giorno entravano nella stanza. Il Brahmino
vide che Siddharta tremava leggermente sulle ginocchia. Nel volto
di Siddharta, invece, non si vedeva alcun tremito: gli occhi
guardavano lontano. Allora il padre s'accorse che Siddharta non
23
Siddharta – Parte Prima
abitava già più con lui in quella casa: Siddharta l'aveva già
abbandonato.
Il padre posò la mano sulla spalla di Siddharta. «Andrai nella
foresta», disse «e diverrai un Samana. Se nella foresta troverai la
beatitudine, ritorna, e insegnami la beatitudine. Se troverai la
delusione, ritorna: riprenderemo insieme a sacrificare agli dèi.
Ora va' a baciar tua madre, dille dove vai. Ma per me è tempo
d'andare al fiume e di compiere la prima abluzione».
Tolse la mano dalla spalla di suo figlio, e uscì. Siddharta
barcollò, quando provò a muoversi. Ma fece forza alle sue
membra, s'inchinò davanti al padre e andò dalla mamma, per fare
come suo padre aveva prescritto.
Quando alle prime luci del giorno, lentamente, con le gambe
indolenzite, lasciò la città ancora silenziosa, un'ombra, ch'era
accucciata presso l'ultima capanna, si levò e s'unì al pellegrino:
Govinda. «Sei venuto» disse Siddharta, e sorrise.
«Sono venuto» disse Govinda.</textarea>
  <button class="btn" id="encryptBtn">&gt; Encrypt (RSA Byte-by-Byte)</button>
  
  <h4>Ciphertext (Pipe '|' Separated):</h4>
  <textarea id="encryptedText" readonly style="color: var(--subtitle);"></textarea>
  <canvas id="cipherChart" class="main-chart"></canvas>

  <hr>

  <!-- STEP 4: ATTACK -->
  <h3>&gt; Step 4 – Hill Climbing Attack</h3>
  <p>The algorithm uses "Random Restarts" to avoid local maximums. It will run the optimization multiple times.</p>
  
  <button class="btn" id="attackBtn" style="border-color: #ff5555; color: #ff5555;">&gt; INITIATE ATTACK SEQUENCE</button>
  
  <h4>Attack Terminal Log:</h4>
  <div id="terminalLog" class="terminal-log">&gt; System Ready. Waiting for command...</div>

  <h4>Final Decrypted Result:</h4>
  <textarea id="decryptedResult" readonly style="height: 100px;"></textarea>

  <hr>

  <!-- STEP 5: VERIFICATION -->
  <h3>&gt; Step 5 – Verification</h3>
  <button class="btn" id="verifyBtn">&gt; Decrypt with Private Key</button>
  <textarea id="verifyResult" readonly style="height: 100px;"></textarea>

</div>

<script>
/* --- THEME MANAGEMENT --- */
const toggleBtn = document.getElementById('toggle');
let cyberpunkMode = false;
function setMode(isCyberpunk) {
  cyberpunkMode = isCyberpunk;
  document.body.classList.toggle('cyberpunk-mode', cyberpunkMode);
  toggleBtn.textContent = cyberpunkMode ? 'Cyberpunk Mode' : 'Matrix Mode';
  
  // Update Charts Colors dynamically
  if (LM.sortedMonograms.length > 0) {
      drawBarChart(LM.monograms, 'langChart', 'Letter Freq');
      drawHeatmap(LM.bigrams, 'bigramChart');
  }
  if (window.cipherFreq) drawBarChart(window.cipherFreq, 'cipherChart', 'Cipher Freq');
}
toggleBtn.addEventListener('click', () => setMode(!cyberpunkMode));

/* --- 1. LANGUAGE MODEL --- */
class LanguageModel {
    constructor() {
        this.monograms = {};
        this.bigrams = {};
        this.logBigrams = {};
        this.alphabet = "abcdefghijklmnopqrstuvwxyz";
        this.sortedMonograms = [];
    }

    reset() {
        this.monograms = {};
        this.bigrams = {};
        this.logBigrams = {};
        this.sortedMonograms = [];
    }

    cleanText(text) {
        return text.toLowerCase().replace(/[^a-z]/g, "");
    }

    train(text) {
        this.reset();
        const clean = this.cleanText(text);
        
        // Initialize counts
        for (let c of this.alphabet) {
            this.monograms[c] = 0;
            this.bigrams[c] = {};
            this.logBigrams[c] = {};
            for (let d of this.alphabet) {
                this.bigrams[c][d] = 0;
                this.logBigrams[c][d] = -15; 
            }
        }

        // Count
        for (let i = 0; i < clean.length - 1; i++) {
            const c1 = clean[i];
            const c2 = clean[i+1];
            this.monograms[c1]++;
            this.bigrams[c1][c2]++;
        }
        this.monograms[clean[clean.length-1]]++;

        // Log Probabilities
        for (let c of this.alphabet) {
            let rowSum = 0;
            for (let d of this.alphabet) rowSum += this.bigrams[c][d];
            if (rowSum > 0) {
                for (let d of this.alphabet) {
                    if (this.bigrams[c][d] > 0) {
                        this.logBigrams[c][d] = Math.log(this.bigrams[c][d] / rowSum);
                    }
                }
            }
        }

        this.sortedMonograms = Object.keys(this.monograms).sort((a,b) => this.monograms[b] - this.monograms[a]);
        return this.monograms;
    }
}
const LM = new LanguageModel();

/* --- 2. RSA ENGINE --- */
let rsaKeys = { e: 0, d: 0, n: 0 };
const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);

function modInverse(e, phi) {
    let m0 = phi, y = 0, x = 1;
    if (phi === 1) return 0;
    while (e > 1) {
        let q = Math.floor(e / phi);
        let t = phi;
        phi = e % phi; e = t;
        t = y;
        y = x - q * y; x = t;
    }
    if (x < 0) x += m0;
    return x;
}

function modPow(base, exp, mod) {
    let res = 1n;
    base = BigInt(base);
    exp = BigInt(exp);
    mod = BigInt(mod);
    while (exp > 0n) {
        if (exp % 2n === 1n) res = (res * base) % mod;
        base = (base * base) % mod;
        exp /= 2n;
    }
    return Number(res);
}

/* --- 3. UI HANDLERS --- */
const logArea = document.getElementById('terminalLog');
function log(msg) {
    logArea.innerHTML += msg + "\n";
    logArea.scrollTop = logArea.scrollHeight;
}

// Handler: Train
document.getElementById('trainBtn').addEventListener('click', () => {
    const text = document.getElementById('trainingText').value;
    if (text.length < 50) return alert("Text too short!");
    LM.train(text);
    document.getElementById('trainStatus').innerText = `> Status: Trained on ${text.length} chars.`;
    
    drawBarChart(LM.monograms, 'langChart', 'Letter Freq');
    drawHeatmap(LM.bigrams, 'bigramChart');
});

// Handler: Setup Keys
document.getElementById('setupBtn').addEventListener('click', () => {
    const p = parseInt(document.getElementById('p').value);
    const q = parseInt(document.getElementById('q').value);
    const e = parseInt(document.getElementById('e').value);
    
    if(!p || !q || !e) return alert("Invalid inputs");
    const n = p * q;
    const phi = (p - 1) * (q - 1);
    if (gcd(e, phi) !== 1) return alert(`'e' must be coprime to phi (${phi})`);
    
    const d = modInverse(e, phi);
    rsaKeys = { e, d, n };
    document.getElementById('rsa-pub').innerText = `> Public Key (e, n): (${e}, ${n})`;
    document.getElementById('rsa-priv').innerText = `> Private Key (d, n): (${d}, ${n})`;
});

// Handler: Encrypt (With '|' Separator)
document.getElementById('encryptBtn').addEventListener('click', () => {
    if(!rsaKeys.n) return alert("Generate keys first!");
    const plain = document.getElementById('inputText').value;
    let out = [];
    
    for(let char of plain) {
        const code = char.toLowerCase().charCodeAt(0);
        // a-z (97-122)
        if(code >= 97 && code <= 122) {
             let m = code - 97; 
             let c = modPow(m, rsaKeys.e, rsaKeys.n);
             out.push(c);
        } else {
             // Store special chars as strings
             out.push(char); 
        }
    }
    // JOIN WITH PIPE '|' to preserve spaces
    document.getElementById('encryptedText').value = out.join('|');
    
    // Stats
    const freq = {};
    out.forEach(c => {
        if(typeof c === 'number') freq[c] = (freq[c]||0)+1;
    });
    window.cipherFreq = freq;
    drawBarChart(freq, 'cipherChart', 'Ciphertext Freq');
});

// Handler: Verify
document.getElementById('verifyBtn').addEventListener('click', () => {
    const raw = document.getElementById('encryptedText').value;
    if(!raw) return;
    
    // SPLIT BY PIPE
    const tokens = raw.split('|');
    let res = "";
    
    tokens.forEach(t => {
        if(!isNaN(t) && t.length > 0 && t !== ' ') {
            const m = modPow(Number(t), rsaKeys.d, rsaKeys.n);
            res += String.fromCharCode(m + 97);
        } else {
            res += t;
        }
    });
    document.getElementById('verifyResult').value = res;
});

/* --- 4. ATTACK LOGIC --- */
document.getElementById('attackBtn').addEventListener('click', async () => {
    const raw = document.getElementById('encryptedText').value;
    if(!raw) return alert("No ciphertext!");
    
    log("------------------------------------------");
    log("> INITIALIZING ATTACK SEQUENCE...");
    
    const tokens = raw.split('|');
    // Extract only numbers for frequency analysis
    const uniqueCipherNums = [...new Set(tokens.filter(t => !isNaN(t) && t.length > 0 && t !== ' '))].map(Number);
    
    if(uniqueCipherNums.length === 0) return log("> Error: No numeric cipher data found.");

    // Freq Analysis
    let cipherFreq = {};
    tokens.forEach(t => {
        if(!isNaN(t) && t.length > 0 && t !== ' ') {
            let n = Number(t);
            cipherFreq[n] = (cipherFreq[n]||0)+1;
        }
    });
    let sortedCipher = Object.keys(cipherFreq).sort((a,b) => cipherFreq[b] - cipherFreq[a]);
    
    log(`> Analyzed ${tokens.length} tokens.`);
    log(`> Found ${sortedCipher.length} unique symbols.`);
    
    // Decrypt Helper (Full text with punctuation)
    const decode = (map) => {
        return tokens.map(t => {
            if(!isNaN(t) && t.length > 0 && t !== ' ') {
                return map[Number(t)] || '?';
            }
            return t;
        }).join('');
    };

    // Score Function (Ignores punctuation)
    const getScore = (text) => {
        let score = 0;
        const letters = text.toLowerCase().replace(/[^a-z]/g, "");
        for(let i=0; i<letters.length-1; i++) {
            let c1 = letters[i], c2 = letters[i+1];
            if(LM.logBigrams[c1] && LM.logBigrams[c1][c2]) {
                score += LM.logBigrams[c1][c2];
            }
        }
        return score;
    };

    // HILL CLIMBING LOOP
    let bestGlobalMap = {};
    let bestGlobalScore = -Infinity;

    for(let run=0; run<3; run++) { 
        log(`> Run ${run+1}/3...`);
        
        // Initial map
        let map = {};
        let alph = LM.sortedMonograms;
        sortedCipher.forEach((sym, i) => {
            if(i < alph.length) map[sym] = alph[i];
            else map[sym] = LM.alphabet[i%26];
        });

        // Perturb
        if(run > 0) {
            for(let k=0; k<5; k++) {
                let i1 = Math.floor(Math.random()*sortedCipher.length);
                let i2 = Math.floor(Math.random()*sortedCipher.length);
                let s1=sortedCipher[i1], s2=sortedCipher[i2];
                [map[s1], map[s2]] = [map[s2], map[s1]];
            }
        }

        let currentScore = getScore(decode(map));
        let improved = true;
        let iter = 0;
        
        while(improved && iter < 800) {
            improved = false;
            iter++;
            
            let i1 = Math.floor(Math.random()*sortedCipher.length);
            let i2 = Math.floor(Math.random()*sortedCipher.length);
            if(i1===i2) continue;
            let s1=sortedCipher[i1], s2=sortedCipher[i2];
            
            // Swap
            let v1 = map[s1], v2 = map[s2];
            map[s1] = v2; map[s2] = v1;
            
            let newScore = getScore(decode(map));
            if(newScore > currentScore) {
                currentScore = newScore;
                improved = true;
            } else {
                map[s1] = v1; map[s2] = v2; // Revert
            }
        }
        
        if(currentScore > bestGlobalScore) {
            bestGlobalScore = currentScore;
            bestGlobalMap = {...map};
            log(`  New Best Score: ${currentScore.toFixed(2)}`);
            document.getElementById('decryptedResult').value = decode(bestGlobalMap);
        }
        await new Promise(r => setTimeout(r, 20));
    }
    log("> ATTACK COMPLETE.");
});

/* --- VISUALIZATION HELPERS (Improved) --- */
const getVar = (name) => getComputedStyle(document.body).getPropertyValue(name).trim();

function drawBarChart(data, id, label) {
  const canvas = document.getElementById(id);
  const ctx = canvas.getContext('2d');
  
  // Set explicit size for drawing buffer
  // Note: CSS controls display size, this controls resolution
  canvas.width = canvas.parentElement.offsetWidth; 
  canvas.height = 300; 

  const w = canvas.width;
  const h = canvas.height;
  
  // Sort and pick top 26
  const sorted = Object.entries(data).sort((a,b)=>b[1]-a[1]).slice(0,26);
  if(sorted.length === 0) return;
  const max = sorted[0][1];
  const padding = 40;
  const barW = (w - (padding*2)) / sorted.length;
  
  ctx.clearRect(0,0,w,h);
  
  const colAccent = getVar('--chart-bar') || '#b6ffb6';
  const colText = getVar('--text') || '#fff';

  // Title
  ctx.fillStyle = colText;
  ctx.font = "16px monospace";
  ctx.fillText(label, 10, 20);

  sorted.forEach((item, i) => {
    let hh = (item[1]/max) * (h - 80);
    let x = padding + i*barW;
    let y = h - 40 - hh;
    
    ctx.fillStyle = colAccent;
    ctx.fillRect(x+2, y, barW-4, hh);

    // Label
    ctx.fillStyle = colText;
    ctx.font = "12px monospace";
    ctx.textAlign = "center";
    
    // Rotate text if bars are thin
    if (barW < 30) {
        ctx.save();
        ctx.translate(x + barW/2, h - 25);
        ctx.rotate(-Math.PI/4);
        ctx.fillText(String(item[0]).toUpperCase(), 0, 0);
        ctx.restore();
    } else {
        ctx.fillText(String(item[0]).toUpperCase(), x + barW/2, h - 20);
    }
  });
}

function drawHeatmap(data, id) {
  const canvas = document.getElementById(id);
  const ctx = canvas.getContext('2d');
  
  const size = 300; // Fixed size for heatmap
  canvas.width = size; 
  canvas.height = size;
  
  const alph = "abcdefghijklmnopqrstuvwxyz";
  const cellS = (size - 30) / 26; 
  
  ctx.clearRect(0,0,size,size);
  
  let max = 0;
  for(let r in data) for(let c in data[r]) max = Math.max(max, data[r][c]);

  const colBase = getVar('--heatmap-base') || '#000';
  const colHigh = getVar('--heatmap-high') || '#0f0';

  // Background
  ctx.fillStyle = colBase;
  ctx.fillRect(0,0,size,size);

  for(let y=0; y<26; y++) {
    for(let x=0; x<26; x++) {
      let charR = alph[y];
      let charC = alph[x];
      let val = data[charR][charC];
      let intensity = val / (max || 1);
      
      let px = 20 + x*cellS;
      let py = 10 + y*cellS;
      
      if(val > 0) {
        ctx.fillStyle = colHigh;
        ctx.globalAlpha = 0.2 + (intensity * 0.8);
        ctx.fillRect(px, py, cellS-0.5, cellS-0.5);
        ctx.globalAlpha = 1;
      } else {
        ctx.strokeStyle = '#222';
        ctx.strokeRect(px, py, cellS, cellS);
      }
    }
    // Labels
    ctx.fillStyle = getVar('--text');
    ctx.font = "9px monospace";
    ctx.fillText(alph[y].toUpperCase(), 5, 10 + y*cellS + cellS/2 + 3);
  }
}

// Auto-run setup
window.onload = () => {
    document.getElementById('trainBtn').click();
    
    const returnBtn = document.createElement('button');
    returnBtn.className = 'btn';
    returnBtn.id = 'backHome';
    returnBtn.textContent = '> return Home';
    returnBtn.style.marginTop = '1.6rem';
    document.querySelector('.container').appendChild(returnBtn);
    document.getElementById('backHome').addEventListener('click', () => {
      window.location.href = './index.html';
    });
};
</script>
</body>
</html>